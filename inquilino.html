<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cargar Imagen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background-color: #ffffff; padding: 20px; margin: 0; }
    .file-input-wrapper { position: relative; overflow: hidden; width: 100%; margin-bottom: 15px; }
    .file-input-wrapper input[type="file"] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; }
    #formImagen { max-width: 500px; width: 90%; margin: 0 auto; padding: 15px; box-sizing: border-box; background: #fff; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    .file-btn { width: 100%; padding: 12px; font-size: 16px; background-color: #1E90FF; color: white; border: none; border-radius: 5px; }
    #formImagen input[type="text"] { width: 100%; padding: 10px; font-size: 16px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
    #enviarWhatsapp { width: 100%; padding: 14px; font-size: 18px; border: none; border-radius: 5px; color: white; background-color: #25D366; cursor: pointer; }
    #enviarWhatsapp:disabled { background-color: #A5D6A7; cursor: not-allowed; }
    @media (max-width: 480px) {
      #formImagen { padding: 10px; }
      #formImagen input[type="text"], .file-btn, #enviarWhatsapp { font-size: 18px; padding: 16px; }
    }
    #inicio { text-align: center; margin-top: 50px; }
    .opciones { display: flex; flex-direction: column; gap: 100px; max-width: 300px; margin: 0 auto; }
    .opciones button { padding: 12px 20px; font-size: 40px; cursor: pointer; background-color: #29ABE2; color: white; border: none; border-radius: 8px; transition: background-color 0.3s ease, transform 0.3s ease; font-family: 'Roboto', sans-serif; font-weight: 500; }
    .opciones button:hover { background-color: #002e5a; transform: scale(1.03); }
    .seccion { display: none; margin-top: 30px; }
    input[type="text"] { height: 60px; }
    .logo img { width: 250px; max-width: 80vw; height: auto; display: block; margin: 0 auto 50px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>

<div id="inicio">
  <div class="logo"><img src="logo.svg" alt="Logo Empresa" /></div>
  <div class="opciones">
    <button onclick="mostrar('formularioCarga','Carga Enegia')">Cargar Enegia</button>
    <button onclick="mostrar('formularioCarga','Pago Arriendo')">Pago Arriendo</button>
  </div>
</div>

<div class="container" id="formularioCarga" style="display: none;">
  <div id="titulo" style="text-align: center;"></div>

  <form id="formImagen">
    <label for="imagen">Selecciona Comprobante:</label>
    <div class="file-input-wrapper">
      <button type="button" class="file-btn">Elegir imagen</button>
      <input type="file" id="imagen" name="imagen" accept="image/*" onchange="previsualizarImagen(event)" required />
    </div>
    <div id="resultadoOCR" style="display:none;"></div>

  

    <input type="text" id="usuario" name="usuario" readonly style="display: none;"/>
    <label for="valor">Contrato:</label>
    <input type="text" id="contrato" name="contrato" readonly />
    <div id="datosExtraidos" style="display:none;">
      <label for="valor">Valor a cargar:</label>
      <input type="text" id="valor" name="valor" readonly />
      <label for="fecha">Fecha:</label>
      <input type="text" id="fecha" name="fecha" readonly />
      <label for="referencia">Referencia:</label>
      <input type="text" id="referencia" name="referencia" readonly />
      <button type="button" id="enviarWhatsapp" disabled style="margin-top:10px; background-color: #25D366;" onclick="enviarDatosAWhatsApp()">
        Enviar a WhatsApp
      </button>
    </div>
  </form>
</div>

<script>
function previsualizarImagen(event) {
  const archivo = event.target.files[0];
  const img = document.getElementById("previewImg");
  if (archivo) {
    const reader = new FileReader();
    reader.onload = function (e) {
      img.src = e.target.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(archivo);
    procesarImagenOCR();
  } else {
    img.src = "";
    img.style.display = "none";
  }
}

async function procesarImagenOCR() {
  const archivo = document.getElementById("imagen").files[0];
  const resultadoOCRDiv = document.getElementById("resultadoOCR");
  if (!archivo) { alert("Selecciona una imagen."); return; }
  resultadoOCRDiv.style.display = "block";
  resultadoOCRDiv.textContent = "Procesando...";
  const reader = new FileReader();
  reader.onload = async function(event) {
    try {
      const { data: { text } } = await Tesseract.recognize(event.target.result, "spa", { logger: m => console.log(m) });
      resultadoOCRDiv.style.display = "none";
      document.getElementById("datosExtraidos").style.display = "block";
      const datos = extraerDatos(text);
      document.getElementById("valor").value = datos.valor || "";
      document.getElementById("fecha").value = datos.fecha ? datos.fecha.join("; ") : "";
      document.getElementById("referencia").value = datos.referencia || "";
      validarCampos();
    } catch(e) {
      resultadoOCRDiv.textContent = "Error OCR: " + e.message;
    }
  }
  reader.readAsDataURL(archivo);
}

function extraerDatos(texto) {
  const fechas = extraerFechas(texto);
  const valores = extraerValores(texto);
  const referencia = extraerReferenciaComprobante(texto);
  return { fecha: fechas.length ? fechas : null, valor: valores.length ? valores[0] : null, referencia };
}

function extraerFechas(texto) { const regex = /\b(?:\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\d{4}[\/\-.]\d{1,2}[\/\-.]\d{1,2})\b/g; return texto.match(regex) || []; }
function extraerValores(texto) { const regex = /(?:\$|COP)?\s*\d{1,3}(?:([.,])\d{3})+(?:[.,]\d{2})?|\d+[.,]\d{2}/g; return texto.match(regex) || []; }
function extraerReferenciaComprobante(texto) { const regex = /\b(?:comprobante|referencia|ref|nro)[^A-Z0-9]*([A-Z0-9\-]{6,})/i; const m = regex.exec(texto); return m ? m[1] : ""; }

async function enviarDatosAWhatsApp() {
  // Cada vez que se pulsa, lee la URL mÃ¡s reciente desde el archivo .dev
  
  const accion = document.querySelector('h2').textContent;
  const usuario = document.getElementById("usuario").value;
  const contrato = document.getElementById("contrato").value;
  const valor = document.getElementById("valor").value;
  const fecha = document.getElementById("fecha").value;
  const referencia = document.getElementById("referencia").value;

  if (!valor && !fecha && !referencia) { alert("No hay datos."); return; }

  const payload = { accion, usuario, contrato, valor, fecha, referencia };

  try {
    const response = await fetch(`#swhome#/recibir`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if(response.ok){
      alert("Datos enviados correctamente.");
      document.getElementById("formImagen").reset();
      document.getElementById("datosExtraidos").style.display = "none";
    } else { alert("Error al enviar."); console.error(await response.text()); }
  } catch(error) { alert("No se pudo conectar."); console.error(error); }
}


function validarCampos() {
  const valor = document.getElementById("valor").value.trim();
  const fecha = document.getElementById("fecha").value.trim();
  const referencia = document.getElementById("referencia").value.trim();
  document.getElementById("enviarWhatsapp").disabled = !(valor || fecha || referencia);
}

window.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const dataBase64 = params.get("data");
  if(dataBase64){
    try{
      const decoded = atob(dataBase64);
      const datos = new URLSearchParams(decoded);
      document.getElementById("contrato").value = datos.get("contrato");
      document.getElementById("usuario").value = datos.get("usuario");
    } catch(e){ console.error("Error al decodificar."); }
  }
});

function mostrar(id,titulo){
  document.getElementById('inicio').style.display='none';
  document.getElementById(id).style.display='block';
  const h2 = document.createElement("h2"); h2.textContent = titulo;
  document.getElementById("titulo").appendChild(h2);
}
</script>
</body>
</html>